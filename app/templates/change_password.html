<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Change Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="{% if theme == 'light' %}bg-gray-100 text-gray-900{% else %}bg-slate-900 text-slate-100{% endif %} min-h-screen flex items-center justify-center">

  <div class="{% if theme == 'light' %}bg-white border-gray-300{% else %}bg-slate-800/90 border-slate-700{% endif %} p-8 rounded-lg shadow-xl w-full max-w-md border">
    <h1 class="text-2xl font-bold {% if theme == 'light' %}text-sky-600{% else %}text-sky-400{% endif %} mb-6 text-center">
      {% if force_reset %}
        Set a New Password
      {% else %}
        Change Your Password
      {% endif %}
    </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="p-3 mb-4 rounded text-sm
            {% if category == 'danger' %}
              {% if theme == 'light' %}bg-red-100 text-red-700 border border-red-300{% else %}bg-red-500/20 text-red-300 border border-red-500/40{% endif %}
            {% elif category == 'success' %}
              {% if theme == 'light' %}bg-green-100 text-green-700 border border-green-300{% else %}bg-green-500/20 text-green-300 border border-green-500/40{% endif %}
            {% else %}
              {% if theme == 'light' %}bg-yellow-100 text-yellow-800 border border-yellow-300{% else %}bg-yellow-500/20 text-yellow-300 border border-yellow-500/40{% endif %}
            {% endif %}">
            {{ msg }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-4">

      {% if not force_reset %}
      <div class="relative">
        <input type="password" name="current_password" id="current_password"
          placeholder="Current Password"
          class="w-full px-4 py-2 rounded
            {% if theme == 'light' %}bg-gray-100 border border-gray-300 text-gray-900 focus:ring-sky-500
            {% else %}bg-slate-700 border border-slate-600 text-slate-100 focus:ring-sky-400{% endif %}
            focus:outline-none focus:ring-2" required>

        <button type="button" onclick="togglePW('current_password', this)"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200">
          <span class="pw-eye">ğŸ‘ï¸</span>
        </button>
      </div>
      {% endif %}

      <div class="relative">
        <input type="password" name="new_password" id="new_password"
          placeholder="New Password"
          class="w-full px-4 py-2 rounded
            {% if theme == 'light' %}bg-gray-100 border border-gray-300 text-gray-900 focus:ring-sky-500
            {% else %}bg-slate-700 border border-slate-600 text-slate-100 focus:ring-sky-400{% endif %}
            focus:outline-none focus:ring-2" required>

        <button type="button" onclick="togglePW('new_password', this)"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200">
          <span class="pw-eye">ğŸ‘ï¸</span>
        </button>
      </div>

      <div class="relative">
        <input type="password" name="confirm_password" id="confirm_password"
          placeholder="Confirm New Password"
          class="w-full px-4 py-2 rounded
            {% if theme == 'light' %}bg-gray-100 border border-gray-300 text-gray-900 focus:ring-sky-500
            {% else %}bg-slate-700 border border-slate-600 text-slate-100 focus:ring-sky-400{% endif %}
            focus:outline-none focus:ring-2" required>

        <button type="button" onclick="togglePW('confirm_password', this)"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200">
          <span class="pw-eye">ğŸ‘ï¸</span>
        </button>
      </div>

      <div class="text-sm {% if theme == 'light' %}text-gray-600{% else %}text-slate-400{% endif %} mt-3">
        <p class="font-semibold {% if theme == 'light' %}text-sky-600{% else %}text-sky-300{% endif %}">
          Password Requirements:
        </p>
        <ul class="list-disc list-inside leading-relaxed">
          <li>Minimum 15 characters</li>
          <li>At least 1 number</li>
          <li>At least 1 special character</li>
        </ul>
      </div>

      <div id="strengthBar"
           class="w-full h-2 {% if theme == 'light' %}bg-gray-200{% else %}bg-slate-700{% endif %} rounded mt-3">
        <div id="strengthIndicator" class="h-2 w-0 rounded bg-red-500 transition-all duration-300"></div>
      </div>

      <button type="submit"
        class="w-full {% if theme == 'light' %}bg-sky-600 hover:bg-sky-700{% else %}bg-sky-500 hover:bg-sky-600{% endif %} text-white font-semibold py-2 rounded transition">
        {% if force_reset %}Save New Password{% else %}Update Password{% endif %}
      </button>
    </form>

    {% if not force_reset %}
    <p class="text-center {% if theme == 'light' %}text-gray-600{% else %}text-slate-400{% endif %} mt-4 text-sm">
      <a href="{{ url_for('dashboard.dashboard') }}"
         class="{% if theme == 'light' %}text-sky-600{% else %}text-sky-400{% endif %} hover:underline">
         â† Return to Dashboard
      </a>
    </p>
    {% endif %}
  </div>

  <script>
    function togglePW(id, btn) {
      const input = document.getElementById(id);
      if (!input) return;

      if (input.type === "password") {
        input.type = "text";
        btn.querySelector(".pw-eye").textContent = "ğŸ™ˆ";
      } else {
        input.type = "password";
        btn.querySelector(".pw-eye").textContent = "ğŸ‘ï¸";
      }
    }

    // Strength indicator
    const newPw = document.getElementById('new_password');
    const bar = document.getElementById('strengthIndicator');

    newPw.addEventListener('input', () => {
      const val = newPw.value;
      let strength = 0;

      if (val.length >= 15) strength++;
      if (/[0-9]/.test(val)) strength++;
      if (/[^A-Za-z0-9]/.test(val)) strength++;
      if (val.length >= 20) strength++;

      const widths = ["0%", "33%", "66%", "100%"];
      const colors = ["bg-red-500", "bg-yellow-500", "bg-green-500", "bg-green-600"];
      strength = Math.min(strength, colors.length - 1);

      bar.className = `h-2 rounded transition-all duration-300 ${colors[strength]}`;
      bar.style.width = widths[strength];
    });
  </script>

</body>
</html>
